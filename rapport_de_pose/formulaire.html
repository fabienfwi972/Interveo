
<!-- Rapport de fin de chantier ‚Äî formulaire.html v1.2.1 -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rapport de fin de chantier</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --accent:#ff6a00; --bg:#f7f7f9; --ink:#111; --muted:#666; --card:#fff; }
    * { box-sizing: border-box; font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin:0; padding:24px; background:var(--bg); color:var(--ink); }
    .container { max-width: 1024px; margin: 0 auto; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin-bottom:18px; }
    h1 { font-size: 28px; margin:0 0 8px; display:flex; align-items:center; gap:10px; }
    h2 { font-size: 18px; margin: 0 0 12px; }
    label { display:block; font-size: 14px; color:#333; margin-bottom:8px; }
    input[type=text], input[type=date], input[type=email], select, textarea {
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; outline:none;
    }
    textarea { min-height: 70px; resize: vertical; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid { display:grid; grid-template-columns: 2fr 1fr; gap: 12px; align-items: start; }
    .btns { display:flex; gap:10px; justify-content:flex-end; }
    button { border:0; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn-primary { background:var(--accent); color:#fff; }
    .btn-secondary { background:#e5e7eb; }
    .photos { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; }
    .photo-preview { border:1px dashed #ddd; border-radius:10px; padding:8px; text-align:center; font-size:12px; }
    canvas { border:1px dashed #ddd; border-radius:8px; width:100%; height:180px; }
    .section-line { padding:10px 12px; border:1px solid #efefef; border-radius:10px; background:#fff; margin-bottom:8px; }
    .k { font-weight:600; }
    .hint { color:#666; font-size:12px }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" style="display:flex; align-items:center; justify-content:space-between;">
      <h1>Rapport de fin de chantier</h1>
      <span style="font-size:12px;color:#666">v1.2.1</span>
    </div>

    <div class="card">
      <h2>Client & chantier</h2>
      <div class="row">
        <div>
          <label>Nom du client</label>
          <input id="clientName" type="text">
        </div>
        <div>
          <label>Email du client</label>
          <input id="clientEmail" type="email">
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div>
          <label>T√©l√©phone</label>
          <input id="clientPhone" type="text">
        </div>
        <div>
          <label>Date des travaux</label>
          <input id="workDate" type="date">
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div>
          <label>Adresse du chantier</label>
          <input id="siteAddress" type="text" placeholder="Num√©ro et rue">
        </div>
        <div>
          <label>Code postal / Ville</label>
          <div class="row" style="grid-template-columns: 1fr 1fr; gap:8px">
            <input id="siteZip" type="text" placeholder="972xx">
            <input id="siteCity" type="text" placeholder="Sch≈ìlcher, Le Diamant‚Ä¶">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div>
          <label>Poseur</label>
          <select id="poseur"></select>
        </div>
        <div>
          <label>M√©nagers divers (install√©s par le client)</label>
          <input id="divers" type="text" placeholder="LL, cafeti√®re‚Ä¶">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Meubles</h2>
      <div id="meubles"></div>
    </div>

    <div class="card">
      <h2>√âlectrom√©nager</h2>
      <div id="electro"></div>
    </div>

    <div class="card">
      <h2>Prestation du poseur</h2>
      <div id="presta"></div>
    </div>

    <div class="card">
      <h2>Photos du chantier</h2>
      <input id="photos" type="file" accept="image/*" multiple />
      <div class="photos" id="previews"></div>
    </div>

    <div class="card">
      <h2>Signatures</h2>
      <div class="row">
        <div>
          <label>Signature du client</label>
          <canvas id="signClient" width="1200" height="300"></canvas>
          <button class="btn-secondary" id="clearSignClient" style="margin-top:8px">Effacer</button>
        </div>
        <div>
          <label>Signature du poseur</label>
          <canvas id="signPoseur" width="1200" height="300"></canvas>
          <button class="btn-secondary" id="clearSignPoseur" style="margin-top:8px">Effacer</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Commentaires g√©n√©raux</h2>
      <textarea id="commentaires" placeholder="Remarques g√©n√©rales, consignes, r√©serves..."></textarea>
    </div>

    <div class="card">
      <div class="btns">
        <button class="btn-secondary" id="saveDraft">üíæ Brouillon</button>
        <button class="btn-primary" id="submitFinal">üìÑ G√©n√©rer le PDF & envoyer</button>
      </div>
      <p class="hint">Compatible ouverture locale : les valeurs de pr√©remplissage et la liste des poseurs ont un fallback.</p>
    </div>
  </div>

  <?!= include('template_pdf'); ?>

  <script>
    const STATUS = ['Conforme','Non conforme','√Ä la charge du client'];

    const MEUBLES = [
      "L'implantation des meubles est conforme au plan sign√©",
      "Les meubles sont correctement positionn√©s",
      "Les fa√ßades et tiroirs sont correctement ajust√©s",
      "Les plans de travail sont correctement install√©s",
      "Les plinthes sont correctement install√©es",
      "Les caches-lumi√®res et les corniches sont correctement install√©s (si fournis par AVIVA)"
    ];

    const ELECTRO = [
      "Le four est correctement install√© et raccord√©",
      "Le micro-onde est correctement install√© et raccord√©",
      "La plaque est correctement install√©e et raccord√©e",
      "La hotte est correctement install√©e et raccord√©e",
      "Le r√©frig√©rateur est correctement install√© et raccord√©",
      "Le lave-vaisselle est correctement install√© et raccord√©",
      "L'√©vier est correctement install√© et raccord√©",
      "M√©nager divers (LL, cafeti√®re...)"
    ];

    const PRESTA = [
      "Le rendez-vous a √©t√© pris au moins 8 jours avant la date de pose",
      "Le chantier est impeccablement nettoy√© lors du d√©part du poseur",
      "Le poseur s'est pr√©sent√© √† l'heure et au jour convenus"
    ];

    // Fallbacks locaux + compatibilit√© Apps Script
    const prefill = (() => { try { return JSON.parse('<?= JSON.stringify(this.prefillJson) ?>'); } catch(e) { return null; } })();
    const poseurs = (() => { try { return JSON.parse('<?= JSON.stringify(this.poseurs) ?>'); } catch(e) { return ["Fabien","Mendel"]; } })();

    const poseurSel = document.getElementById('poseur');
    poseurs.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; poseurSel.appendChild(o); });

    function section(containerId, items, preObj) {
      const pre = preObj || {}; // <‚Äî s√©curit√© null/undefined
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(name => {
        const wrap = document.createElement('div');
        wrap.className = 'section-line';
        const grid = document.createElement('div');
        grid.className = 'grid';

        const left = document.createElement('div');
        left.innerHTML = '<span class="k">'+name+'</span>';

        const right = document.createElement('div');
        const sel = document.createElement('select');
        STATUS.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
        sel.value = (pre[name] && pre[name].status) || 'Conforme';

        const cmt = document.createElement('textarea');
        cmt.placeholder = 'Commentaire (obligatoire si Non conforme)';
        cmt.style.display = (sel.value === 'Non conforme') ? 'block' : 'none';
        cmt.value = (pre[name] && pre[name].comment) || '';

        const charge = document.createElement('input');
        charge.type = 'text';
        charge.placeholder = 'Pr√©cision si ‚Äú√Ä la charge du client‚Äù (ex: pi√®ce manquante, erreur de mesure‚Ä¶)';
        charge.style.display = (sel.value === '√Ä la charge du client') ? 'block' : 'none';
        charge.value = (pre[name] && pre[name].chargeNote) || '';

        sel.addEventListener('change', () => {
          cmt.style.display = sel.value === 'Non conforme' ? 'block' : 'none';
          charge.style.display = sel.value === '√Ä la charge du client' ? 'block' : 'none';
        });

        right.appendChild(sel);
        right.appendChild(cmt);
        right.appendChild(charge);

        grid.appendChild(left); grid.appendChild(right);
        wrap.appendChild(grid);
        container.appendChild(wrap);
      });
    }

    section('meubles', MEUBLES, (prefill && prefill.meubles) || {});
    section('electro', ELECTRO, (prefill && prefill.electromenager) || {});
    section('presta', PRESTA, (prefill && prefill.prestaPoseur) || {});

    // Pr√©visualisation locale : neutralisation des actions c√¥t√© Apps Script
    document.getElementById('saveDraft').addEventListener('click', () => alert('En local : pas de sauvegarde.'));
    document.getElementById('submitFinal').addEventListener('click', () => alert('En local : g√©n√©ration PDF/d√©p√¥t d√©sactiv√©s.'));
  </script>
</body>
</html>
